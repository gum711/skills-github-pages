<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>نموذج تنبيه نعاس — نسخة الويب</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0b1220; color: #e8eefc; }
    .wrap { display: grid; place-items: center; min-height: 100vh; padding: 16px; }
    .card { width: min(700px, 100%); background: #131c31; border: 1px solid #223052; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { font-size: 20px; margin: 0 0 8px; }
    p { margin: 6px 0; line-height: 1.6; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
    button { appearance: none; border: 0; background: #2a3a67; color: #fff; padding: 10px 14px; border-radius: 12px; font-weight: 600; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .panel { background: #0f1628; border: 1px solid #223052; border-radius: 12px; padding: 12px; }
    video, canvas { width: 100%; max-height: 50vh; border-radius: 12px; background: #000; }
    .stats { display: flex; gap: 12px; font-size: 14px; opacity: .9; flex-wrap: wrap; }
    .dot { display:inline-block; width:12px; height:12px; border-radius:50%; vertical-align:middle; margin-inline-start:6px; background:#7cf39b; }
    .dot.red { background:#ff6b6b; }
    .dot.green { background:#7cf39b; }
    .tag { background: #1c2a4f; padding: 6px 10px; border-radius: 999px; }
    .ok { color: #7cf39b; }
    .warn { color: #ffcc70; }
    .alert { color: #ff6b6b; font-weight: 700; }
    .footer { opacity: .7; font-size: 12px; margin-top: 8px; }
    label { font-size: 14px; opacity: .9; }
    input[type=range] { width: 100%; }
  </style>
  <!-- Mediapipe Face Mesh + utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>مشروع مجموعه الابتكار</h1>
      <p>نموذج اولي لفكره تنبيه السائق في حال الخمول اثناء النوم بالذكاء الاصطناعي</p>

      <div class="controls">
        <button id="startBtn">بدء</button>
        <button id="stopBtn" disabled>إيقاف</button>
      </div>

      <div class="row">
        <div class="panel">
          <video id="video" playsinline muted></video>
          <canvas id="overlay"></canvas>
        </div>
        <div class="panel">
          <div class="stats">
            <span class="tag">EAR: <span id="earVal">-</span></span>
            <span class="tag">الحالة: <span id="state">جاهز</span></span>
            <span class="tag">مغلق منذ: <span id="closedMs">0</span> ms</span>
            <span class="tag">العينان: <span id="led" class="dot green"></span></span>
          </div>
          
          </div>
        </div>
      </div>

      
    </div>
  </div>

  <script>
    // عناصر الواجهة
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const video    = document.getElementById('video');
    const canvas   = document.getElementById('overlay');
    const ctx      = canvas.getContext('2d');
    const earSpan  = document.getElementById('earVal');
    const stateEl  = document.getElementById('state');
    const closedEl = document.getElementById('closedMs');
    const ledEl    = document.getElementById('led');
    
    // Web Audio
    let audioCtx, osc, gain;

    function initAudio() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      gain = audioCtx.createGain();
      gain.gain.value = 0.0; // ابدأ صامتًا
      osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = 1000; // 1 كيلوهرتز
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
    }

    function setVolume(v) {
      if (!gain) return;
      const now = audioCtx.currentTime;
      gain.gain.cancelScheduledValues(now);
      gain.gain.setTargetAtTime(v, now, 0.05); // سموث
    }

    function stopAudio() {
      if (!audioCtx) return;
      setVolume(0);
    }

    // حالة الكشف
    let closedStart = null; // طابع زمني عند بداية الإغلاق
    const HOLD_MS = 1000;   // 1s قبل بدء التنبيه
    const THRESH = 0.27; // عتبة افتراضية ثابتة لاغلاق العين
    const RAMP_MS = 4000;   // للوصول لأقصى صوت

    // EAR من نقاط العين (6 نقاط لكل عين)
    function euclid(a, b) { const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx, dy); }
    function ear(eye) {
      const A = euclid(eye[1], eye[5]);
      const B = euclid(eye[2], eye[4]);
      const C = euclid(eye[0], eye[3]);
      return (A + B) / (2.0 * C);
    }

    // مؤشرات العينين على Mediapipe FaceMesh (refineLandmarks=true)
    // عين يسار: 33,160,158,133,153,144
    // عين يمين: 362,385,387,263,373,380
    function pickEyeLandmarks(lms, idx) { return idx.map(i => ({x:lms[i].x, y:lms[i].y})); }

    // تهيئة الفيديو والكاميرا الأمامية
    let camera, faceMesh;

    function resizeCanvas() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }

    async function start() {
      // لقيود iOS: نحتاج ضغط المستخدم لبدء الصوت والكاميرا
      initAudio();

      await stop();

      // Mediapipe FaceMesh
      faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
      faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      faceMesh.onResults(onResults);

      // استخدم utils.Camera لتغذية الإطارات لـ FaceMesh بدقة مناسبة للموبايل
      camera = new Camera(video, {
        onFrame: async () => { await faceMesh.send({image: video}); },
        width: 640, height: 480, facingMode: 'user'
      });

      await camera.start();
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      startBtn.disabled = true; stopBtn.disabled = false;
      stateEl.textContent = 'يعمل';
    }

    async function stop() {
      try { if (camera) { await camera.stop(); } } catch(e){}
      camera = null; faceMesh = null; stopAudio();
      startBtn.disabled = false; stopBtn.disabled = true;
      stateEl.textContent = 'متوقف';
      ctx.clearRect(0,0,canvas.width, canvas.height);
      closedStart = null; earSpan.textContent = '-'; closedEl.textContent = '0';
    }

    function onResults(res) {
      if (!res.multiFaceLandmarks || res.multiFaceLandmarks.length === 0) {
        drawFrame(null);
        handleEyesOpen();
        return;
      }
      const lms = res.multiFaceLandmarks[0];
      const left = pickEyeLandmarks(lms, [33,160,158,133,153,144]);
      const right= pickEyeLandmarks(lms, [362,385,387,263,373,380]);

      const leftEAR = ear(left);
      const rightEAR= ear(right);
      const avgEAR = (leftEAR + rightEAR) / 2;
      earSpan.textContent = avgEAR.toFixed(3);

      // رسم بسيط
      drawFrame(lms, left, right);

      const thresh = THRESH;
      const eyesClosed = avgEAR < thresh;
      if (eyesClosed) {
        if (typeof ledEl !== 'undefined' && ledEl) { ledEl.classList.remove('green'); ledEl.classList.add('red'); }
        if (!closedStart) closedStart = performance.now();
        const elapsed = performance.now() - closedStart;
        closedEl.textContent = elapsed.toFixed(0);
        if (elapsed >= HOLD_MS) {
          // ابدأ بصوت منخفض ثم ازده تدريجيًا
          const t = Math.max(0, elapsed - HOLD_MS);
          const vol = Math.min(1.0, 0.10 + (t / RAMP_MS));
          setVolume(vol);
        } else {
          setVolume(0.0);
        }
      } else {
        handleEyesOpen();
      }
    }

    function handleEyesOpen() {
      closedStart = null; closedEl.textContent = '0'; setVolume(0.0);
      if (typeof ledEl !== 'undefined' && ledEl) { ledEl.classList.remove('red'); ledEl.classList.add('green'); }
    }

    function drawFrame(lms, left, right) {
      if (!video.videoWidth) return;
      ctx.clearRect(0,0,canvas.width, canvas.height);
      if (!lms) return;

      // تحويل الإحداثيات النسبية إلى بكسلات
      const W = canvas.width, H = canvas.height;
      function toXY(p){ return [p.x*W, p.y*H]; }

      ctx.lineWidth = 2;
      ctx.strokeStyle = '#66d3ff';
      ctx.fillStyle = '#66d3ff';

      function drawEye(pts) {
        ctx.beginPath();
        pts.forEach((p,i)=>{
          const [x,y] = toXY(p);
          if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        const [x0,y0] = toXY(pts[0]);
        ctx.lineTo(x0,y0);
        ctx.stroke();
      }

      if (left && right) { drawEye(left); drawEye(right); }
    }

    // أزرار
    startBtn.addEventListener('click', async ()=>{
      try {
        await start();
        // iOS: استئناف AudioContext بعد تفاعل المستخدم
        if (audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();
      } catch (e) {
        alert('تعذر بدء الكاميرا. يرجى السماح بالوصول أو إعادة المحاولة.');
        console.error(e);
      }
    });
    stopBtn.addEventListener('click', stop);

    // إيقاف الصوت عند تبديل التبويب/الخروج
    document.addEventListener('visibilitychange', ()=>{
      if (document.hidden) { stopAudio(); }
    });
  </script>
</body>
</html>
